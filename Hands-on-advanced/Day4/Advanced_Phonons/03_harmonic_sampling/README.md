# HARMONIC SAMPLING and ANHARMONICITY QUANTIFICATION


### Thermodynamic Sampling

To obtain **accurate** thermodynamic expectation values of observables, MD simulations are usually essential to sample phase space. In this context, expectation values are usually defined as 

$$
\begin{align}
	\langle O \rangle
	=
	\lim_{t_0 \rightarrow \infty} \frac{1}{t_0}
	\int_0^{t_0} {\rm d} t ~
	O \left( \mathbf{R} (t), {\bf P} (t)\right)
\end{align}
$$,

where  $\,O \left( \mathbf{R} (t), {\bf P} (t) \right)\,$ denotes the instantaneous value of the observable $O$ obtained for the phase-space configuration with positions ${\bf R} (t)$ and momenta ${\bf P} (t)$ evaluated with respect to the the full many-body Hamiltonian $\mathcal H ({\bf P}, {\bf R})$. For example, $O$ could be the instantaneous pressure, the temperature, or the band gap.

You will learn more about thermodynamic expectation values and MD in tomorrow's lecture. 
In MD simulations, the many-body potential $\mathcal V$ needs to be evaluated _both_ for propagating the dynamical evolution of the system, and for evaluating the observable along the trajectory.
Today, we will use a need little trick to circumvent the dynamical propagation, so that we can avoid explicitly simulating the time-dependence $t$. 
We achieve this by generating samples, i.e. representative configurations for a certain temperature, from a harmonic distribution. This allows to get an estimate of the thermodynamic expectation value _if representative samples can be generated by other means_.

We now present a way to create these samples based on the harmonic approximation. In this approximation, the potential is given by

$$
\begin{align}
	\mathcal V^{(2)} ({\bf R})
	= \frac{1}{2} \sum_{I, J}
		\Delta {\bf R}_I \cdot \Phi_{IJ} \Delta {\bf R}_J~,
\end{align}
$$

with the $3 \times 3$ force constant matrices $\Phi_{IJ}$ and atomic displacements $\Delta {\bf R}_I$. The Newton equations of motion therefore read

$$
\begin{align}
\left(
\begin{array}{c}
M_{1} \Delta \ddot{\mathbf{R}}_{1} \\
M_{2} \Delta \mathbf{R}_{2} \\
\vdots \\
M_{N} \Delta \ddot{\mathbf{R}}_{N}
\end{array}\right)=\left(\begin{array}{cccc}
\Phi_{11} & \Phi_{12} & \cdots & \Phi_{1 N} \\
\Phi_{21} & \Phi_{22} & \cdots & \Phi_{2 N} \\
\vdots & \vdots & \ddots & \vdots \\
\Phi_{N 1} & \Phi_{N 2} & \cdots & \Phi_{N N}
\end{array}\right)\left(\begin{array}{c}
\Delta \mathbf{R}_{1} \\
\Delta \mathbf{R}_{2} \\
\vdots \\
\Delta \mathbf{R}_{N}
\end{array}\right)~,
\end{align}
$$

and can be solved analytically, yielding

$$
\begin{align}
\Delta {\bf R}_I (t)
	= \frac{1}{\sqrt{M_I}} \sum_s {\bf e}_{sI} A_s \sin (\omega_s t + \phi_s)~,
\end{align}
$$

where ${\bf e}_{sI}$ denotes the eigenvector of the dynamical matrix $D_{IJ} = \Phi_{IJ} / \sqrt{M_I M_J}$ corresponding to atom $I$ and phonon mode $s$ and $\omega_s$ the respective frequency. The amplitudes $A_s$ and phases $\phi_s$ are fixed by the initial condition $\{{\bf R} (t_0), {\bf P} (t_0) \}$, where in thermal equilibrium

$$
\begin{align}
\left\langle A_{s}\right\rangle
	=
	\sqrt{
	\frac{\hbar}{\omega_{s}}\left(n_{\mathrm{B}}(\omega_s, T)+\frac{1}{2}\right)
	}
	~\stackrel{k_{\rm B} T \,\gg\, \hbar \omega_s}{\longrightarrow}~
	\frac{\sqrt{2 k_{\rm B} T}}{\omega_s}~.
\end{align}
$$

Noting that $\sin (\omega_s t + \phi_s)$ is essentially a random number in $[-1, 1]$, and mimicking thermal fluctuations, samples can be generated by

$$
\begin{align}
\Delta {\bf R}_{I} (n)
	=\frac{1}{\sqrt{M_{I}}} \sum_{s} \zeta_{s} (n) \left\langle A_{s}\right\rangle {\bf e}_{s I}~,
\end{align}
$$

where $\langle A_s \rangle$ is given by Eq. 5 and each $\zeta_s (n)$ is a normally distributed random number, where  $n$ labels the sample. As mentioned above, these samples are geometric configurations that reflect the distribution of configurations that one would observe at a certain temperature in the *harmonic* approximation.


## Anharmonicity

To inspect and gauge anharmonic effects, we define the anharmonic contribution to the potential energy $\mathcal{V} (\mathbf{R})$ as

$$
\begin{align}
	\mathcal{V}^{\rm A}(\mathbf{R}) \equiv \mathcal{V}(\mathbf{R})-\mathcal{V}^{(2)}(\mathbf{R})~,
\end{align}
$$

where $\mathcal{V}^{(2)}(\mathbf{R})$ at a given atomic configuration $\mathbf{R}$ is given by

$$
\begin{align}
	\mathcal{V}^{(2)}\left(\mathbf{R}=\mathbf{R}^{0}+\Delta \mathbf{R}\right)
	=\frac{1}{2} \sum_{I, J} \Phi_{\alpha \beta}^{I, J} \Delta R_{I}^{\alpha} \Delta R_{J}^{\beta}~,
\end{align}
$$

with the harmonic force constants $\Phi^{IJ}$ obtained at the equilibrium configuration $\mathbf{R}^0$ as

$$
\begin{align}
	\Phi_{\alpha, \beta}^{I, J}
	=\left.\frac{\partial^{2} \mathcal{V}}{\partial R_{I}^{\alpha} \partial R_{J}^{\beta}}\right|_{\mathbf{R}^{0}}~.
\end{align}
$$

Likewise, we define the anharmonic contribution to the force components $F_{I, \alpha} (\mathbf{R})$ as

$$
\begin{align}
	F_{I, \alpha}^{\mathrm{A}}(\mathbf{R})
	&=
	F_{I, \alpha}(\mathbf{R})-F_{t, \alpha}^{(2)}(\mathbf{R})~,\text{ with} \\
	F_{I, \alpha}^{(2)}
	&=
	-\sum_{J, \beta} \Phi_{\alpha, \beta}^{I, J} \Delta R_{J}^{\beta}
\end{align}
$$

In order to estimate the strength of anharmonic effects in a material, we define the _anharmonicity measure_

$$
\begin{align}
\sigma^{\mathrm{A}}(T) \equiv \frac{\sigma\left[F^{\mathrm{A}}\right]_{T}}{\sigma[F]_{T}}=\sqrt{\frac{\sum_{I, \alpha}\left\langle\left(F_{I, \alpha}^{\mathrm{A}}\right)^{2}\right\rangle_{T}}{\sum_{I, \alpha}\left\langle\left(F_{I, \alpha}\right)^{2}\right\rangle_{T}}}~,
\end{align}
$$

where $\langle \cdot \rangle_T$ denotes an expectation value at a given temperature,

$$
\begin{align}
	\left\langle O \right\rangle
	= \lim _{N_{\mathrm{t}} \rightarrow \infty}
	\frac{1}{N_{\mathrm{t}}} \sum_{n}^{N_{\mathrm{t}}} \left(t_{n}\right)~.
\end{align}
$$

$F_{I, \alpha} (t) \equiv F_{I, \alpha}\left(\mathbf{R}(t)\right)$ is the force component $\alpha$ on atom $I$ at time $t$, and $F^{A}_{I, \alpha}$ is given by Eq. 10. $\sigma^{A} (T)$ therefore quantifies the _average strength of anharmonic force components_ $F_{I, \alpha}^{A}$, normalized by the average strength of forces $F_{I, \alpha}$, observed at temperature $T$.

The necessary ingredient to evaluate Eq. 12 are:

- Atomic forces $F_{I, \alpha}$,
- harmonic force constants $\Phi^{IJ}$ to compute $F^{(2)}$ according to Eq. 11 for evaluating $F^{\rm A}$ according to Eq. 10 , and
- thermodynamic expectation values according to Eq. 13 viz. 1.

These ingredients can be obtained with `FHI-vibes` with the following workflow:

- Take the materials of interest and generate a reference structure, i.e., a primitive cell and a supercell.
- Obtain force constants for the supercell as introduced in the phonons tutorial.
- Generate representative samples, as discussed above, using the harmonic approximation.
- Evaluate $\sigma^{A} (T)$.

N.B. For anharmonic materials, it is necessary to explicitly run an MD simulation for the supercell to obtain correct values for $\sigma^{A} (T)$.




## Example: LDA-Si at 300K

### Obtain force constants

We will reuse the calculation from the previous tutorial on phonon calculations in the conventional cell with 8 atoms. So enter the exercise folder and copy your previous phonon calculation there:

```
cd 03_harmonic_sampling
cd input               
cp -r ../../02_phonons/input/sc_0008 .
```

As start, perform the postprocess in the `sc_0008` folder:

```
cd sc_0008/
vibes output phonopy phonopy/trajectory.son -bs
```

Check the bandstructure in `output/bandstructure.pdf` for plausibility.

We now prepare and remap the force constants to the supercell. Currently, the force constants are written to `output/FORCE_CONSTANTS` in a condensed representation in a $(N_{\rm prim}, N, 3, 3)$ shape, where $N_{\rm prim}$ is the number of atoms in the primitive cell and $N$ is the number of atoms in the supercell. For creating samples, they need to be mapped to a full $3 N \times 3N$ shape. This can be done with the CLI tool `vibes utils fc remap`,

```
cd phonopy/output
vibes utils fc remap
```

which will create `FORCE_CONSTANTS_remapped` as a plain, `numpy` readable text file.

The current folder should now contain the following files:

```
>>> ls
bandstructure_dos.pdf  bandstructure.pdf  band.yaml  FORCE_CONSTANTS  FORCE_CONSTANTS_remapped  FORCE_SETS  geometry.in.primitive  geometry.in.supercell  phonopy.yaml  thermal_properties.pdf  thermal_properties.yaml  total_dos.dat
```

We are now ready to create samples according to Eq. 6.

### Create samples

Samples can be created with the CLI tool `utils create-samples`. We want to do that at the root of
the input folder, so copy all relevant files there:
and move to that directory. 
```
cp geometry.in.* FORCE_CONSTANTS* ../../..
cd ../../..
```
_Remark: copying the `geometry.in.primitive` is optional. However, you should always know from where you started, it might save some hours of unnecessary work at some point :-)._

We now create 10 samples according to Eq. 6 at a temperature of $300\,{\rm K}$.
First, we go back to the initial `input` directory and then run

```
vibes utils create-samples geometry.in.supercell -fc FORCE_CONSTANTS_remapped -n 10 -T 300
```

The geometry files are written as `geometry.in.supercell.0300K.???` to the  current directory. Let's move them to a folder called `samples_300K`:

```
mkdir samples_300K
mv geometry.in.supercell.* samples_300K
```

### Evaluate the samples

In order to compute the energy and forces in all samples, prepare an `aims.in` like this:

```text
[files]
geometries:                    samples_300K/geometry.in.*
primitive:                     geometry.in.primitive
supercell:                     geometry.in.supercell

[calculator]
name:                          aims
socketio:                      true
workdir:                       aims_300K

[calculator.parameters]
xc:                            pw-lda
compute_forces:                true

[calculator.kpoints]
density:                       2

[calculator.basissets]
default:                       light
```
For your convenience, such an `aims.in` file has already been prepared in the `input` directory.
With that, we can run a calculation for all structures found in `samples_300K/geometry.in.*` and write the results to a `trajectory.son` file in the directory `aims_300K`.

Run the calculation with

```
vibes run singlepoint aims.in | tee log.aims
```

This will take around 9 minutes on your machine.

We now postprocess these samples by running `vibes output md`:

```
cd  aims_300K
vibes output md
```

Note that this postprocessing can also be performed on samples from MD data, hence the syntax. Since this is not an MD, the time axis in the dataset will simply label the samples instead of corresponding to an actual simulation time.


### Evaluating anharmonicity with `FHI-vibes`

We now have all the necessary ingredients to evaluate $\sigma^{\rm A}$ for this system!

In the `aims_300K` directory, where your `trajectory.nc` dataset is located, execute

```
vibes utils trajectory update trajectory.nc -fc ../FORCE_CONSTANTS
```

to read the force constants from `FORCE_CONSTANTS` and attach them to the trajectory dataset.

To evaluate Eq. 12, you can now use the CLI tool `info anharmonicity`:

```
vibes info anharmonicity trajectory.nc
```

which will give you the total $\sigma^{\rm A}$ value (`sigma`), as well as an individual value for each atom species. The output should be

```
Compute anharmonicity measure for trajectory.nc:
 parse trajectory.nc
[mode]         Project forces onto modes
[mode]         .. time elapsed: 0.726s
[mode]         Project harmonic forces onto modes
[mode]         .. time elapsed: 0.001s

DataFrame:
       sigma  sigma_atom_mean  sigma [Si]  sigma_mode
Si  0.143432         0.143432    0.143432     0.14614

.. Dataframe for Si written to sigmaA_Si.csv
```

This tells you that the average magnitude of anharmonic contributions to the forces, $F^{\rm A}$, in LDA-Silicon at $300\,{\rm K}$ is about $14\,\%$. Be careful: This is a statistical metric and we have only used 10 samples, which are too few for convergence. Accordingly, the number you get could actually differ from this value.

## Mode resolved anharmonicity

To obtain a mode-resolved $\sigma^{\rm A}_s$, you can run

```
vibes info anharmonicity trajectory.nc --per_mode
```

which will produce a `.csv` file containing mode frequencies $\omega_s$ in THz and the respective mode-resolved anharmonicity $\sigma^{\rm A}_s$.

You can plot these data with a Python script

```python
import pandas as pd

s = pd.read_csv("sigmaA_mode_Si.csv", index_col=0)

ax = s.plot(marker=".", lw=0)

ax.set_xlim(0, 20)
ax.set_ylim(0, 0.5)

ax.set_xlabel("$\omega_s$ (THz)")
ax.set_ylabel(r"$\sigma^{\rm A}_s$")

fig = ax.get_figure()
fig.savefig("Mode_resolved_sigma.png")
```
which you can also find as `plot.py` in `input`. Copy `plot.py` to `aims_300K` and execute `python3 plot.py`.

The plot in the file `Mode_resolved_sigma.png` won't look too impressive, showing very low anharmonicity. In part, this is because we're using a small supercell, but even in large and converged supercells the anharmonicity in silicon is overall quite weak. But you should be good to go to investigate the anharmonicity of your material of choice by now -- Happy Computing 💪


## Take Home Messages

The sampling trick can be used to rapidly estimate the expectation value of a static observable and typically converges 1-2 orders of magnitude faster than a MD simulation.

The sampling trick only works if the harmonic approximation is a good reference for the system of interest. This might or might not be the case and is difficult to tell _a priori_. The here presented anharmonicity metric can be used to gauge the strength of anharmonic effects.

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    TeX: { equationNumbers: { autoNumber: "AMS" } }
  });
</script>
